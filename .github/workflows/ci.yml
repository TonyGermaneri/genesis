name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================
  # Format Check (I-2)
  # ============================================
  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  # ============================================
  # Clippy Lint (I-2)
  # ============================================
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Clippy check
        run: cargo clippy --workspace --all-targets -- -D warnings

  # ============================================
  # Test Suite (I-3)
  # ============================================
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run tests
        run: cargo test --workspace

  # ============================================
  # Build Check
  # ============================================
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build workspace
        run: cargo build --workspace

  # ============================================
  # MSRV Check (Minimum Supported Rust Version)
  # ============================================
  msrv:
    name: MSRV (1.75)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.75
      - uses: Swatinem/rust-cache@v2
      - name: Check MSRV
        run: cargo check --workspace

  # ============================================
  # Nix Build (I-4)
  # ============================================
  nix-build:
    name: Nix Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - uses: cachix/cachix-action@v14
        with:
          name: nix-community
          skipPush: true
      - name: Nix build
        run: nix build --print-build-logs
      - name: Nix flake check
        run: nix flake check

  # ============================================
  # Build Telemetry (I-10)
  # ============================================
  telemetry:
    name: Build Telemetry
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      
      - name: Collect build metrics
        id: metrics
        run: |
          chmod +x scripts/telemetry.sh
          ./scripts/telemetry.sh --json > telemetry.json
          cat telemetry.json
          
          # Extract values for outputs
          echo "build_time=$(jq -r '.build_time_seconds' telemetry.json)" >> $GITHUB_OUTPUT
          echo "binary_size=$(jq -r '.binary_size_bytes' telemetry.json)" >> $GITHUB_OUTPUT
          echo "dep_count=$(jq -r '.dependency_count' telemetry.json)" >> $GITHUB_OUTPUT

      - name: Upload telemetry artifact
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-${{ github.sha }}
          path: |
            telemetry.json
            build.log
          retention-days: 90

      - name: Check binary size regression
        run: |
          CURRENT_SIZE=${{ steps.metrics.outputs.binary_size }}
          # Set threshold at 100MB (adjust as needed)
          THRESHOLD=104857600
          
          if [ "$CURRENT_SIZE" -gt "$THRESHOLD" ]; then
            echo "::warning::Binary size ($CURRENT_SIZE bytes) exceeds threshold ($THRESHOLD bytes)"
          fi
          
          echo "Binary size: $CURRENT_SIZE bytes"
